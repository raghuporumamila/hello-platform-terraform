name: Platform Delivery Pipeline

on:
  pull_request:
    branches: [ main, develop ]
  #push:
  #  branches: [ main, develop ]

jobs:
  # --- STAGE 0: SETUP (Determines Environment) ---
  setup:
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.set_env.outputs.env_name }}
      project_id: ${{ steps.set_env.outputs.project_id }}
      tf_dir: ${{ steps.set_env.outputs.tf_dir }}
    steps:
      - id: set_env
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "env_name=prod" >> $GITHUB_OUTPUT
            echo "project_id=${{ secrets.GCP_PROJECT_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "tf_dir=./terraform/environments/prod" >> $GITHUB_OUTPUT
          else
            echo "env_name=dev" >> $GITHUB_OUTPUT
            echo "project_id=${{ secrets.GCP_PROJECT_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "tf_dir=./terraform/environments/dev" >> $GITHUB_OUTPUT
          fi

  # --- STAGE 1: VALIDATE ---
  validate:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Terraform Validate
        run: |
          cd ${{ needs.setup.outputs.tf_dir }}
          terraform init
          terraform validate

  # --- STAGE 3: DEPLOY ---
    # ... (Previous jobs: setup,) ...

    deploy:
      needs: [ setup ]
      if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'develop')
      runs-on: ubuntu-latest

      # This key link triggers the Manual Approval Gate in the UI
      environment: ${{ needs.setup.outputs.env_name }}

      permissions:
        contents: 'read'
        id-token: 'write'

      steps:
        - uses: actions/checkout@v4

        - name: Google Auth
          uses: 'google-github-actions/auth@v2'
          with:
            workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
            service_account: ${{ secrets.GCP_SA_EMAIL }}

        - name: Terraform Apply
          run: |
            cd ${{ needs.setup.outputs.tf_dir }}
            terraform init
            terraform apply -auto-approve \
              -var="project_id=${{ needs.setup.outputs.project_id }}" \
              -var="image_url=gcr.io/${{ needs.setup.outputs.project_id }}/platform-service:${{ github.sha }}" \
              -var="commit_sha=${{ github.sha }}"